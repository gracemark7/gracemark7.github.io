<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node.js+KOA2 | Grace&#39;s Blog</title>
    <meta name="description" content="信仰、工作、生活">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.b2fa97c3.css" as="style"><link rel="preload" href="/assets/js/app.25f0ea44.js" as="script"><link rel="preload" href="/assets/js/16.bc7aa871.js" as="script"><link rel="prefetch" href="/assets/js/10.d5d2af0e.js"><link rel="prefetch" href="/assets/js/11.ba12862c.js"><link rel="prefetch" href="/assets/js/12.eeb86992.js"><link rel="prefetch" href="/assets/js/13.4882fd4d.js"><link rel="prefetch" href="/assets/js/14.00078334.js"><link rel="prefetch" href="/assets/js/15.58a01617.js"><link rel="prefetch" href="/assets/js/17.18777b3f.js"><link rel="prefetch" href="/assets/js/18.e47c9be0.js"><link rel="prefetch" href="/assets/js/19.6b63b600.js"><link rel="prefetch" href="/assets/js/20.41efddb4.js"><link rel="prefetch" href="/assets/js/21.28410378.js"><link rel="prefetch" href="/assets/js/22.8625582d.js"><link rel="prefetch" href="/assets/js/23.6e5545be.js"><link rel="prefetch" href="/assets/js/24.81855949.js"><link rel="prefetch" href="/assets/js/25.d7829336.js"><link rel="prefetch" href="/assets/js/26.fbda8f6e.js"><link rel="prefetch" href="/assets/js/27.f897798b.js"><link rel="prefetch" href="/assets/js/28.a44f0ce5.js"><link rel="prefetch" href="/assets/js/29.47707aff.js"><link rel="prefetch" href="/assets/js/3.bf92a271.js"><link rel="prefetch" href="/assets/js/4.a187db1a.js"><link rel="prefetch" href="/assets/js/5.35112557.js"><link rel="prefetch" href="/assets/js/6.0272308b.js"><link rel="prefetch" href="/assets/js/7.71191f64.js"><link rel="prefetch" href="/assets/js/8.8d6740dd.js"><link rel="prefetch" href="/assets/js/9.69e4dc6f.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.32940b96.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b2fa97c3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div><header id="navbarWrapper" class="navbar"><div class="sidebar-button"><i class="iconfont reco-menu"></i></div> <a href="/" class="home-link router-link-active"><img src="/images/chizhiyiheng.png" alt="Grace's Blog" class="logo"> <span class="site-name">Grace's Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="side-search-wrapper"><div class="search-box" data-v-1b2e3b29><input aria-label="Search" autocomplete="off" spellcheck="false" value="" data-v-1b2e3b29> <i class="iconfont reco-search" data-v-1b2e3b29></i> <!----></div></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/markTime/" class="nav-link"><i class="iconfont undefined"></i>
  生活
</a></div><div class="nav-item"><a href="/techNology/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  工作
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont undefined"></i>
  归档
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Life.html" class="nav-link"><i class="iconfont undefined"></i>
  生活
</a></li><li class="dropdown-item"><!----> <a href="/categories/Faith.html" class="nav-link"><i class="iconfont undefined"></i>
  信仰
</a></li><li class="dropdown-item"><!----> <a href="/categories/Work.html" class="nav-link"><i class="iconfont undefined"></i>
  工作
</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><i class="iconfont undefined"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://shanyue.tech/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  山月行
  </a></li><li class="dropdown-item"><!----> <a href="https://q.shanyue.tech/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  大厂面试每日一题
  </a></li><li class="dropdown-item"><!----> <a href="https://liuxiangyang.space/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  刘向洋
  </a></li><li class="dropdown-item"><!----> <a href="http://blog.devtang.com/2020/01/01/2019-summary/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  唐巧
  </a></li><li class="dropdown-item"><!----> <a href="https://biaochenxuying.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  夜尽天明
  </a></li></ul></div></div><div class="nav-item"><a href="/myNews/" class="nav-link"><i class="iconfont undefined"></i>
  关于我
</a></div><div class="nav-item"><a href="https://github.com/xilewangzi" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Github
  </a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><div class="side-search-wrapper"><div class="search-box" data-v-1b2e3b29><input aria-label="Search" autocomplete="off" spellcheck="false" value="" data-v-1b2e3b29> <i class="iconfont reco-search" data-v-1b2e3b29></i> <!----></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/markTime/" class="nav-link"><i class="iconfont undefined"></i>
  生活
</a></div><div class="nav-item"><a href="/techNology/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  工作
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont undefined"></i>
  归档
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Life.html" class="nav-link"><i class="iconfont undefined"></i>
  生活
</a></li><li class="dropdown-item"><!----> <a href="/categories/Faith.html" class="nav-link"><i class="iconfont undefined"></i>
  信仰
</a></li><li class="dropdown-item"><!----> <a href="/categories/Work.html" class="nav-link"><i class="iconfont undefined"></i>
  工作
</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><i class="iconfont undefined"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://shanyue.tech/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  山月行
  </a></li><li class="dropdown-item"><!----> <a href="https://q.shanyue.tech/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  大厂面试每日一题
  </a></li><li class="dropdown-item"><!----> <a href="https://liuxiangyang.space/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  刘向洋
  </a></li><li class="dropdown-item"><!----> <a href="http://blog.devtang.com/2020/01/01/2019-summary/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  唐巧
  </a></li><li class="dropdown-item"><!----> <a href="https://biaochenxuying.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  夜尽天明
  </a></li></ul></div></div><div class="nav-item"><a href="/myNews/" class="nav-link"><i class="iconfont undefined"></i>
  关于我
</a></div><div class="nav-item"><a href="https://github.com/xilewangzi" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  Github
  </a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Node.js+KOA2</span> <!----></p> <ul class="sidebar-group-items"></ul></div></li></ul> </div> <div class="page reco-hide" data-v-23c3ef88> <div class="page-title" data-v-23c3ef88><h1 data-v-23c3ef88>Node.js+KOA2</h1> <hr data-v-23c3ef88> <div data-v-48defabe data-v-23c3ef88><i class="iconfont reco-account" data-v-48defabe><span data-v-48defabe>grace</span></i> <i class="iconfont reco-date" data-v-48defabe><span data-v-48defabe>2021/9/1</span></i> <!----> <i class="iconfont reco-tag tags" data-v-48defabe><span class="tag-item" data-v-48defabe>
      Nodejs
    </span></i></div></div> <div class="content" data-v-23c3ef88><h5 id="第一章、用-node-js-koa2-打造超好用的-web-框架"><a href="#第一章、用-node-js-koa2-打造超好用的-web-框架" class="header-anchor">#</a> 第一章、用 Node.js KOA2 打造超好用的 Web 框架</h5> <p>二次开发
异步编程模型</p> <p>编程思维、
面向对象、
Sequelize 与 MySQL</p> <p>Nodejs 能力：
NodeJS Stream（前端工程化基础）
脱离浏览器运行 JS
服务端 API
作为中间层</p> <p>CTO 往往是由服务端工程师担任
技术架构、考虑全局、公司重要资产（数据）</p> <p>javascript 语言本身的深度进阶</p> <p>语法 Python  VS   ES2019
原型链 工程化 oo</p> <p>面向对象</p> <p>NodeJS 脱离浏览器</p> <p>异步
async await
资源 http 异步 操作数据库</p> <h5 id="第二章-koa2-的那点事儿与异步编程模型"><a href="#第二章-koa2-的那点事儿与异步编程模型" class="header-anchor">#</a> 第二章 Koa2 的那点事儿与异步编程模型</h5> <p>1、
MySQL （XAMPP）
Navicat （数据库可视化管理工具）
nodemon （自动重启服务器工具）pm2
nvm 管理 node 版本</p> <p>Node js 脱离浏览器
3、
后端：读写数据库   提供 API
//写出好的代码、提高开发效率
悲观锁、乐观锁、事务、脏读、幻读
API 低级、基础、
基于 NodeJs 专业开发 web KOA Express
洋葱模型 精简 KOA 二次开发 比较好用
定制化能力越强 喜好 习惯 二次开发 非常好用 高级 KOA
Lin CMS ：KOA+Vue
4、
项目独立命名
服务器程序：
Commons require</p> <p>es6 Import from</p> <p>AMD</p> <p>//实验特性 es6 es7 node 
//es10 import decorator class
TC39 查看最新 js 特性提案
babel es6 转换 es5
TS Typescript 
5、
洋葱模型</p> <p>异步编程解决方案：</p> <p>Promise async await  基础是 Promise</p> <p>await：（  求值关键字   对表达式求值、阻塞当前线程）
异步操作：对资源、读文件、发送 http  操作数据库
axios  基于 Promise</p> <p>const res = await axiso.get('https://www.baidu.com/') //1min</p> <p>加上 await，本来是异步的调用变成同步调用</p> <p>C#
async：返回 promise</p> <p>async function f1(){
  return &quot;hello&quot;
}</p> <p>console.log(f1())</p> <p>async await  异步终极解决方案</p> <p>异步编程思维</p> <p>API 网站：http://bl.7yue.pro/dev/classic.html#id2</p> <p>中间件：函数</p> <p>中间件返回 promise</p> <p>上下文（Context）</p> <p>Koa Context  将  node  的  request  和  response  对象封装到单个对象中，为编写  Web  应用程序和  API  提供了许多有用的方法。  这些操作在  HTTP  服务器开发中频繁使用，它们被添加到此级别而不是更高级别的框架，这将强制中间件重新实现此通用功能。</p> <p>为什么一定要按照洋葱模型</p> <h5 id="第三章-路由系统的改造"><a href="#第三章-路由系统的改造" class="header-anchor">#</a> 第三章   路由系统的改造</h5> <p>路由
自动加载路由注册  require-directory</p> <p>类的思想</p> <p>路由拆分</p> <p>动脑筋   思考   能不能简化。程序员一定要懒</p> <p>服务端（数据库设计）  主题   模型</p> <p>Process.cwd()  当前 Node.js 进程执行时的工作目录</p> <p>__dirname:  当前模块的目录名</p> <h5 id="第四章-异步异常与全局异常处理"><a href="#第四章-异步异常与全局异常处理" class="header-anchor">#</a> 第四章 异步异常与全局异常处理</h5> <p><em>异步异常处理</em></p> <p>参数获取与 LinValidator 校验器</p> <p>TP5 Python WTForms LinValidator</p> <p>函数返回 promise 加上 async await ，使用 try catch 进行处理，异步和同步就没什么区别
<strong>深入理解 promie</strong>
Promise async await</p> <p>Koa 库 包 返回的是封装好的 promise 例如：axios、Sequelize</p> <p>awiat 对一个表达式来求值</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>function func1(){
   func2()
}
async function func2(){
  try{
   await func3()
  }catch(error){
    console.log(&quot;error1&quot;,error)
  }
}
//全局异常处理
function func3(){
   return new  Promise((resolve,reject)=&gt;{
    const r = Math.random()
    if(r&lt;0.5){
      reject('error2')
    }
   })
  // return await setTimeout(function(){
  //   throw new Error('error2')
  // },1000)
}
func1()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>//监听   全局异常处理</p> <p>//中间件 --全局异常处理 AOP 面向切面编程
监听错误，输出一段有意义的提醒信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>const catchError = async (ctx,next) =&gt; {
  try {
   await next()
  }catch (error){
    //error 堆栈调用
    //j简化 清晰明了的信息 给前端
    //      HTTP 状态码  Code
    ctx.body = &quot;服务器错误！！！&quot;
    //message
    //error_code 详细，开发者自己定义 10001 20003
    //request_url 当前请求url
    //已知型错误 param int ‘'abc'  已知
    //处理错误，明确
    try catch 处理错误 明确

    //未知型错误 程序潜在错误 无意识 根本不知道错误
    //链接数据库 账号 密码    输入错误

  }
} 
module.exports = catchError
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>定义异常返回格式</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//全局中间件
const catchError = async (ctx,next) =&gt; {
  try {
   await next()
  }catch (error){
    if(error.errorCode){
      ctx.body = {
        msg:error.message,
        error_code:error.errorCode,
        requestUrl: error.requestUrl
      }
      ctx.status = error.status
    }
  }
} 
module.exports = catchError
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>//list.js</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>router.post(&quot;/v1/:id/list/listDate&quot;,(ctx,next) =&gt; {
  const path = ctx.params
  const query = ctx.request.query
  const headers = ctx.request.header
  const body = ctx.request.body
  if(true){
   const error =   new Error(&quot;为什么错误&quot;)
   error.errorCode = 10001
   error.status = 400
   error.requestUrl = `${ctx.method}${ctx.path}`
   throw error
  }
  ctx.body = {
    key:'这里是数据77'
  }
  // throw new Error('API Exception')
})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>//定义 HttpException 异常基类</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>class HttpException extends Error {
 constructor(msg='服务器异常',errorCode=10000,code=400){
   super()
   this.errorCode = errorCode
   this.code = code
   this.msg = msg
 }
}
module.exports = { 
 HttpException 
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>//特定异常类与 global 全局变量</p> <h5 id="第五章-linvalidator-校验器与-sequelize-orm-生成-mysql-数据表"><a href="#第五章-linvalidator-校验器与-sequelize-orm-生成-mysql-数据表" class="header-anchor">#</a> 第五章 LinValidator 校验器与 Sequelize Orm 生成 MySQL 数据表</h5> <p><strong>持久存储数据</strong></p> <p>4、
关系型数据库：
MS 持久化数据  SQLServer Oracle   PostgresSQL
SQL 语言 增删改查
CRUD
ORM</p> <p>非关系型数据库  
Redis（key：value）做缓存  
 MongoDB(文档型数据库) 持续化数据、 ODM</p> <p>数据库 增删改查</p> <p>SQL 语言</p> <p>XAMPP</p> <p>数据库可视化工具：</p> <p>Navicat 管理 MySQL</p> <p>Sequelize 连接数据库   配置一些数据库的参数</p> <p>Sequelize 框架
<a href="https://sequelize.org/" target="_blank" rel="noopener noreferrer">Sequelize 官方文档：<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
Sequelize 是一个基于 Promise 的 Node.js ORM，适用于 Postgres、MySQL、MariaDB、SQLite 和 Microsoft SQL Server。 它具有可靠的事务支持、关系、急切和延迟加载、读取复制等。</p> <p>主键不能为空 不能重复</p> <p><a href="https://github.com/TaleLin" target="_blank" rel="noopener noreferrer">gitHub-lincms<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>nodejs  异步编程思维</p> <p>性能：并发量处理的好</p></div> <!----> <!----> <!----> <div class="page-edit" data-v-23c3ef88><!----> <div class="last-updated" data-v-23c3ef88><span class="prefix" data-v-23c3ef88>Last Updated: </span> <span class="time" data-v-23c3ef88>4/17/2022, 5:16:59 PM</span></div></div> <!----> </div> <div class="valine-wrapper" data-v-1fab1fd0><div id="valine" data-v-1fab1fd0></div></div> <!----> <!----> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-41016a8b data-v-41016a8b><i class="iconfont reco-up" data-v-41016a8b></i></div></div></div></div>
    <script src="/assets/js/app.25f0ea44.js" defer></script><script src="/assets/js/16.bc7aa871.js" defer></script>
  </body>
</html>
